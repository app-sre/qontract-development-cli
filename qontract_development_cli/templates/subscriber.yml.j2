services:
  # qontract-api (Event Subscriber)
  qontract-api-subscriber:
    container_name: qontract-api-subscriber
    platform: {{ profile.settings.qontract_api_subscriber_container_platform or env.settings.container_platform }}
    {% if profile.settings.qontract_api_subscriber_build_image %}
    build:
      context: {{ profile.settings.qontract_reconcile_path.expanduser().absolute() }}
      dockerfile: {{ profile.settings.qontract_api_path.expanduser().absolute() }}/Dockerfile
      target: debug
    {% else %}
    image: {{ profile.settings.qontract_api_subscriber_image }}
    {% endif %}

    ports:
    - 8081:8080
    - {{ profile.settings.qontract_api_subscriber_debugger_port }}:5678  # debugpy port

    environment:
    - QAPI_START_MODE=subscriber
    - QAPI_CACHE_BROKER_URL=redis://cache:6379/0
    # Enable debugpy
    - DEBUGGER_ENABLED={% if profile.settings.debugger %}true{% else %}false{% endif %}
    # Hot reload for development
    - AUTO_RELOAD=1

    volumes:
    - {{ profile.settings.qontract_api_path.expanduser().absolute() }}/app.sh:/opt/app-root/src/app.sh:z
    - {{ profile.settings.qontract_api_path.expanduser().absolute() }}/.env:/opt/app-root/src/.env:z
    - {{ profile.settings.qontract_api_path.expanduser().absolute() }}/qontract_api:/opt/app-root/src/qontract_api/qontract_api:z
    - {{ profile.settings.qontract_reconcile_path.expanduser().absolute() }}/qontract_utils/qontract_utils:/opt/app-root/src/qontract_utils/qontract_utils:z
